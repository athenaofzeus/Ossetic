{% extends "base.html" %}
{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}
{% block content %}
    <div class="container mb-2">
        <div class="row align-items-center justify-content-between">
            <div class="col-12 col-lg-3 text-center row g-1">
                <div class="col-12 mb-2">
                    <div>
                        <button type="submit" class="btn btn-primary" form="settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div class="col-12 mb-2">
                    <div>
                        <a href="{{ url_for('download_db') }}" class="btn btn-warning">–°–∫–∞—á–∞—Ç—å –ë–î</a>
                    </div>
                </div>
                <div class="col-12">
                    <div>
                        <a href="{{ url_for('maintenance') }}" class="btn btn-danger">{% if maintenance %}–í—ã–∫–ª—é—á–∏—Ç—å –¢–û{% else %}–í–∫–ª—é—á–∏—Ç—å –¢–û{% endif %}</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-9">
                <p>
                    –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≥–ª–æ—Å—Å—ã –∏–ª–∏ –ø–æ–º–µ—Ç—ã –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –ø–æ–ª–µ ¬´–ì–ª–æ—Å—Å–∞¬ª/¬´–ü–æ–º–µ—Ç–∞¬ª. –ï—Å–ª–∏ —ç—Ç–∞ –≥–ª–æ—Å—Å–∞
                    –∏–ª–∏ –ø–æ–º–µ—Ç–∞ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –æ–Ω–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.
                </p>
                <p>
                    ¬´–†–∞–Ω–≥¬ª –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ß–µ–º –≤—ã—à–µ —Ä–∞–Ω–≥, —Ç–µ–º —Ä–∞–Ω—å—à–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è
                    –µ–¥–∏–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ (–ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å—Ç–∞—Ç–µ–π, –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞). –†–∞–Ω–≥ –º–æ–∂–Ω–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å; —Ç–∞–∫–∏–µ
                    —ç–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É.
                </p>
                <p>
                    ¬´–¢–∏–ø¬ª –ø–æ–º–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–º—É, –≤ –∫–∞–∫–æ–π –∑–æ–Ω–µ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è: —É —Ñ–æ—Ä–º –∏ –∑–Ω–∞—á–µ–Ω–∏–π, –≤ –∫–∞—á–µ—Å—Ç–≤–µ
                    –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, —Ç–∞–∫—Å–æ–Ω–æ–º–∏–∏ –∏ —Ç.¬†–¥.
                </p>
                <span>
                    –ì–ª–æ—Å—Å—ã —Å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–ª–µ–º ¬´–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞¬ª —è–≤–ª—è—é—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ (–Ω—É–∂–Ω—ã–º–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞) –∏ –Ω–µ
                    –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∏ –≤ –∫–∞–∫–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö.
                </span>
            </div>
        </div>
        <form action="" method="post" id="settings">
            <div class="container row my-2">
                <div class="col-12 col-xl-5 row-cols-1">
                    <div class="col-auto row row-cols-2 align-items-center justify-content-around py-2 my-2 border-top border-bottom border-2">
                        <div class="col-auto">
                            <span class="text-center h5">–ì–ª–æ—Å—Å—ã</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success" onclick="add(glosses, 'gl')" type="button">
                                <span class="text-center">–î–æ–±–∞–≤–∏—Ç—å –≥–ª–æ—Å—Å—É</span>
                            </button>
                        </div>
                    </div>
                    <div class="col">
                        <div class="table-responsive overflow-auto" style="height: 60vh">
                            <table class="table" id="glosses">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">–ì–ª–æ—Å—Å–∞</th>
                                    <th scope="col">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</th>
                                    <th scope="col">
                                        <span data-bs-toggle="tooltip"
                                              title="–ú–µ—Å—Ç–æ –≥–ª–æ—Å—Å—ã –≤ –ø–æ—Ä—è–¥–∫–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ —Å–ª–æ–≤–∞—Ä–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π">
                                            –†–∞–Ω–≥
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {%- for gl in Glosses.query.order_by(Glosses.rank.asc()).all() -%}
                                    <tr class="align-items-center">
                                        <th scope="row">
                                            <span>{{ gl.gloss_id }}</span>
                                        </th>
                                        <td>
                                            <input class="form-control"
                                                   value="{{ gl.russian }}"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                                                   name="gl_gloss_{{ gl.gloss_id }}"
                                                   id="gl_gloss_{{ gl.gloss_id }}"
                                            >
                                        </td>
                                        <td>
                                            <input class="form-control"
                                                   value="{{ gl.english }}"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É"
                                                   name="gl_decode_{{ gl.gloss_id }}"
                                                   id="gl_decode_{{ gl.gloss_id }}"
                                            >
                                        </td>
                                        <td>
                                            <input class="form-control"
                                                   value="{{ gl.rank }}"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–Ω–≥"
                                                   name="gl_rank_{{ gl.gloss_id }}"
                                                   id="gl_rank_{{ gl.gloss_id }}"
                                                   type="number"
                                            >
                                        </td>
                                    </tr>
                                {%- endfor -%}
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-7 row-cols-1">
                    <div class="col-auto row row-cols-2 align-items-center justify-content-around py-2 my-2 border-top border-bottom border-2">
                        <div class="col-auto">
                            <span class="text-center h5">–ü–æ–º–µ—Ç—ã</span>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-success" onclick="add(labels_table, 'l')" type="button">
                            <span class="text-center">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–º–µ—Ç—É</span>
                        </button>
                        </div>
                    </div>
                    <div class="col">
                        <div class="table-responsive overflow-auto" style="height: 60vh">
                            <table class="table" id="labels_table">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">–ü–æ–º–µ—Ç–∞</th>
                                    <th scope="col">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</th>
                                    <th scope="col">
                                        <span data-bs-toggle="tooltip"
                                              title="–ú–µ—Å—Ç–æ –ø–æ–º–µ—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ —Å–ª–æ–≤–∞—Ä–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π">
                                            –†–∞–Ω–≥
                                        </span>
                                    </th>
                                    <th scope="col" style="max-width: 20vw">
                                        <span>
                                            –¢–∏–ø
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {%- for l in Label_names.query.order_by(Label_names.type.asc(), Label_names.rank.asc()).all() -%}
                                    <tr>
                                        <th scope="row">
                                            <a href="{{ url_for('listing', type=l.type, label_id=l.label_id) }}" target="_blank">{{ l.label_id }}</a>
                                        </th>
                                        <td>
                                            <input class="form-control"
                                                   value="{{ l.label }}"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                                                   name="l_label_{{ l.label_id }}"
                                                   id="l_label_{{ l.label_id }}"
                                            >
                                        </td>
                                        <td>
                                            <input class="form-control"
                                                   value="{{ l.decode }}"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É"
                                                   name="l_decode_{{ l.label_id }}"
                                                   id="l_decode_{{ l.label_id }}"
                                            >
                                        </td>
                                        <td>
                                            <input class="form-control"
                                                   value="{{ l.rank }}"
                                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–Ω–≥"
                                                   name="l_rank_{{ l.label_id }}"
                                                   id="l_rank_{{ l.label_id }}"
                                                   type="number"
                                            >
                                        </td>
                                        <td>
                                            <div class="row align-items-center justify-content-center">
                                                <div class="col-12 text-center">
                                                    <select class="form-select" name="l_type_{{ l.label_id }}" onchange="disable_pos(l_pos_button_{{ l.label_id }}, this.value, 'l_pos_{{ l.label_id }}_')">
                                                        <option value="1"{% if l.type == 1 %} selected{% endif %}>
                                                            –§–æ—Ä–º—ã –∏ –∑–Ω–∞—á–µ–Ω–∏—è
                                                        </option>
                                                        <option value="2"{% if l.type == 2 %} selected{% endif %}>
                                                            –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞
                                                        </option>
                                                        <option value="3"{% if l.type == 3 %} selected{% endif %}>
                                                            –¢–∞–∫—Å–æ–Ω–æ–º–∏—è
                                                        </option>
                                                        <option value="4"{% if l.type == 4 %} selected{% endif %}>
                                                            –¢–æ–ø–æ–ª–æ–≥–∏—è
                                                        </option>
                                                        <option value="5"{% if l.type == 5 %} selected{% endif %}>
                                                            –ú–µ—Ä–µ–æ–ª–æ–≥–∏—è
                                                        </option>
                                                    </select>
                                                </div>
                                                <div class="col-12 text-center">
                                                    <a class="text-primary {% if l.type != 2 %}d-none{% endif %}"
                                                       href="javascript:;"
                                                       role="button"
                                                       id="l_pos_button_{{ l.label_id }}"
                                                       data-bs-toggle="dropdown"
                                                       data-bs-auto-close="outside"
                                                       aria-expanded="false"
                                                       style="text-decoration-line: none; font-variant: small-caps"
                                                    >
                                                        {% if l.pos_id %}
                                                            <div class="row">
                                                                {% for pos in Check.split(l.pos_id, ',')  %}
                                                                    <div class="col-auto">{{ Parts_of_speech.query.get(Check.int(pos)).pos_short }}</div>
                                                                {% endfor %}
                                                            </div>
                                                        {% else %}
                                                           –ß–∞—Å—Ç–∏ —Ä–µ—á–∏
                                                        {% endif %}
                                                    </a>
                                                    <ul class="dropdown-menu p-1 overflow-auto" style="height: 200px;" aria-labelledby="dropdownMenuButton">
                                                        {% for pos in Parts_of_speech.query.all() %}
                                                            <li>
                                                                <div class="form-check">
                                                                    <input class="form-check-input"
                                                                           type="checkbox"
                                                                           value="{{ pos.pos_id }}"
                                                                           full_name="{{ pos.pos_short }}"
                                                                           id="l_pos_{{ l.label_id }}_{{ pos.pos_id }}"
                                                                           name="l_pos_{{ pos.pos_id }}_{{ l.label_id }}"
                                                                           onclick="addLabels('l_pos_button_{{ l.label_id }}', 'l_pos_{{ l.label_id }}_{{ pos.pos_id }}')"
                                                                           {% if Check.str(pos.pos_id) in Check.split(l.pos_id, ',') %}checked{% endif %}
                                                                    >
                                                                    <label class="form-check-label"
                                                                           for="l_pos_{{ l.label_id }}_{{ pos.pos_id }}"
                                                                           data-bs-toggle="tooltip"
                                                                           title="{{ pos.pos }}"
                                                                           style="font-variant: small-caps"
                                                                    >
                                                                        {{ Amend.md(pos.pos_short) }}
                                                                    </label>
                                                                </div>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {%- endfor -%}
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script>
        function add(table, type) {
            if (table.rows.length && table.rows.length > 0) {
                var current_num = table.rows.length - 1;
            }
            else {
                var current_num = 1;
            }
            var template = document.createElement('tr');
            if (type == 'l') {
                template.innerHTML = `
                <tr>
                    <th scope="row">
                        <span class="text-center">üÜï</span>
                    </th>
                    <td>
                        <input class="form-control"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                               name="new_${type}_name_${current_num}"
                               id="new_${type}_name_${current_num}"
                        >
                    </td>
                    <td>
                        <input class="form-control"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É"
                               name="new_${type}_decode_${current_num}"
                               id="new_${type}_decode_${current_num}"
                        >
                    </td>
                    <td>
                        <input class="form-control"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–Ω–≥"
                               name="new_${type}_rank_${current_num}"
                               id="new_${type}_rank_${current_num}"
                               type="number"
                        >
                    </td>
                    <td>
                        <div class="row align-items-center justify-content-center">
                            <div class="col-12 text-center">
                                <select class="form-select" name="new_${type}_type_${current_num}" onchange="disable_pos(new_${type}_pos_button_${current_num}, this.value, 'new_${type}_pos_${current_num}_')">
                                    <option value="1">
                                        –§–æ—Ä–º—ã –∏ –∑–Ω–∞—á–µ–Ω–∏—è
                                    </option>
                                    <option value="2">
                                        –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞
                                    </option>
                                    <option value="3">
                                        –¢–∞–∫—Å–æ–Ω–æ–º–∏—è
                                    </option>
                                    <option value="4">
                                        –¢–æ–ø–æ–ª–æ–≥–∏—è
                                    </option>
                                    <option value="5">
                                        –ú–µ—Ä–µ–æ–ª–æ–≥–∏—è
                                    </option>
                                </select>
                            </div>
                            <div class="col-12 text-center">
                                <a class="text-primary d-none"
                                   href="javascript:;"
                                   role="button"
                                   id="new_${type}_pos_button_${current_num}"
                                   data-bs-toggle="dropdown"
                                   data-bs-auto-close="outside"
                                   aria-expanded="false"
                                   style="text-decoration-line: none; font-variant: small-caps"
                                >
                                     <span>–ß–∞—Å—Ç–∏ —Ä–µ—á–∏</span>
                                </a>
                                <ul class="dropdown-menu p-1 overflow-auto" style="height: 200px;" aria-labelledby="dropdownMenuButton">
                                    {% for pos in Parts_of_speech.query.all() %}
                                        <li>
                                            <div class="form-check">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       value="{{ pos.pos_id }}"
                                                       full_name="{{ pos.pos_short }}"
                                                       id="new_${type}_pos_${current_num}_{{ pos.pos_id }}"
                                                       name="new_${type}_pos_{{ pos.pos_id }}_${current_num}"
                                                       onclick="addLabels('new_${type}_pos_button_${current_num}', 'new_${type}_pos_${current_num}_{{ pos.pos_id }}')"
                                                       disabled
                                                >
                                                <label class="form-check-label"
                                                       for="new_${type}_pos_${current_num}_{{ pos.pos_id }}"
                                                       data-bs-toggle="tooltip"
                                                       title="{{ pos.pos }}"
                                                       style="font-variant: small-caps"
                                                >
                                                    {{ Amend.md(pos.pos_short) }}
                                                </label>
                                            </div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>`
            }
            else {
                template.innerHTML = `
                    <tr>
                        <th scope="row">
                            <span class="text-center">üÜï</span>
                        </th>
                        <td>
                            <input class="form-control"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                                   name="new_${type}_name_${current_num}"
                                   id="new_${type}_name_${current_num}"
                            >
                        </td>
                        <td>
                            <input class="form-control"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É"
                                   name="new_${type}_decode_${current_num}"
                                   id="new_${type}_decode_${current_num}"
                            >
                        </td>
                        <td>
                            <input class="form-control"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–Ω–≥"
                                   name="new_${type}_rank_${current_num}"
                                   id="new_${type}_rank_${current_num}"
                                   type="number"
                            >
                        </td>
                    </tr>`
            }
            table.getElementsByTagName("tbody")[0].appendChild(template);
            $(template).attr("tabindex",-1).focus();
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        }

        function addLabels(aim, dropdown) {
            if ($(`#${dropdown}`).is(':checked')) {
                const re_ns = RegExp('\n', 'g');
                const re_spaces = RegExp(' +$', 'gm');
                var current_text = $(`#${aim}`).text().replaceAll(re_ns, '').replace(re_spaces, '');
                if (current_text.match('–ß–∞—Å—Ç–∏ —Ä–µ—á–∏')) {
                    var selected = [$(`#${dropdown}`).attr('full_name')];
                } else {
                    var selected = [current_text, $(`#${dropdown}`).attr('full_name')];
                }
                $(`#${aim}`).text(selected.join(', '));
            } else {
                var label = $(`#${dropdown}`).attr('full_name');
                const re = RegExp(`(, )*${label}`.replace('\.', '\\\.'), 'g');
                const re_spaces = RegExp('[ \n]+$', 'gm');
                const re_beginning = RegExp('^[ \n]*, ', 'gm');
                var new_text = $(`#${aim}`).text().replace(re, '').replace(re_spaces, '');
                if (new_text == '') {
                    new_text = '–ß–∞—Å—Ç–∏ —Ä–µ—á–∏'
                }
                new_text = new_text.replace(re_beginning, '')
                $(`#${aim}`).text(new_text)
            }
        };

        function disable_pos(button, type, startswith) {
            if (type == 2) {
                $(button).removeClass('d-none');
                for (let i of $(`input[id^=${startswith}]`)) {
                    $(i).prop('disabled', false)
                }
            } else {
                console.log($(button));
                $(button).addClass('d-none');
                console.log($(button));
                for (let i of $(`input[id^=${startswith}]`)) {
                    $(i).prop('disabled', true)
                }
            }

        }
    </script>
{% endblock %}